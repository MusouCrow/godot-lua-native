# godot-lua-native 开发范式（C++ ↔ Lua）

本文档用于约束本项目的开发方式：C++ 负责选择并实现导出给 Lua 的接口；Lua 负责以同步、命令式方式驱动 Godot。接口以 **C 风格**为主，避免把 Godot 的复杂数据结构直接映射到 Lua。

## 目标与边界

- **主范式**：Lua → Godot（同步调用、命令式）。
- **Lua 侧类型**：仅允许 `nil / bool / int / number / string / handle(uint64)`。
- **不导出 Godot 结构体**：原则上不把 `Vector2/Vector3/Transform/...` 等结构直接暴露为 Lua 表或 userdata。
- **跨平台优先**：接口语义应在 Windows/macOS/Linux 上一致；无法保证时必须在错误信息中说明原因。

## C++ 与 Lua 的职责划分

### C++ 负责

- 选择要暴露的 API（按模块组织），并实现 **严格的入参校验**、**可读错误**、**清晰语义**。
- 把 Godot 的对象/资源等能力包装为最少类型的参数与返回值（见“值与句柄约定”）。
- 维护“Lua 创建对象”的所有权记录（见“所有权与销毁”）。
- 确保所有 Godot 交互发生在主线程（见“线程模型”）。

### Lua 负责

- 只通过项目导出的模块调用 Godot；不依赖 userdata/元方法/GC 做对象生命周期管理。
- 显式销毁自己创建且自己拥有的对象（调用 `destroy(handle)` 或对象所属模块的销毁接口）。
- 在需要修改窗口模式/尺寸等状态时，按 API 语义分步调用（例如先切 `windowed` 再设大小）。

## 模块组织与命名

- Lua 侧以模块承载导出函数：建议统一前缀 `gd.<module>`。
- 功能会按领域划分为多个模块分别导出到 Lua（例如窗口/显示、输入、文件/路径、资源、场景树等）。
- 模块名与函数名尽量贴近 Godot 概念与语义，避免把所有“系统相关”能力堆到单一模块里导致失控膨胀。
- 函数名应体现作用域，避免冲突：例如 `<module>.<scope>_<action>(...)` 或 `<module>.<object>_<verb>(...)`。

## 值与句柄约定（Lua ↔ C++）

### 基础值

- `bool`、`int`、`number(double)`、`string` 直接映射。
- 不引入复合结构（表/数组/字典）作为公共 ABI；如确有必要，需单独设计并写入本 README。

### handle（对象句柄）

- `handle` 统一为 `uint64`，表示 Godot 的 `instance_id`（`ObjectID`）。
- Lua 永远不拿 C++ 指针，不保存 `lightuserdata` 指针，不假设句柄地址稳定。
- 任何接收 `handle` 的接口必须：
  1) 校验 `handle != 0`
  2) 通过 `ObjectDB`（或等价机制）查找对象
  3) 不存在则直接报错（见“错误模型”）

## 所有权与销毁（显式管理）

本项目约定：**Lua 不依赖 GC 管理 Godot 对象生命周期**，而是显式销毁。

### owned 规则

- “Lua 创建”的对象在 C++ 侧记录为 **owned**（例如维护 `OwnedSet<ObjectID>`）。
- Lua 仅能销毁 owned 对象；尝试销毁非 owned 对象必须报错（防止误删场景树/引擎对象）。

### destroy 规则

- 提供统一的显式销毁入口（可位于合适模块或公共模块中），语义为“请求销毁该对象”：
  - 若对象不存在：报错（强一致性，避免静默吞错）
  - 若对象非 owned：报错 `not owned`
  - 若对象是 `Node`：一律调用 `queue_free()`，把实际释放时机交给 Godot 管理
  - 非 `Node` 对象：按 Godot 4 的对象释放约定实现（在实现处写清楚）
- **自动清理 owned 记录**：当 owned 对象收到销毁通知（如 `NOTIFICATION_PREDELETE` 或等价机制）时，从 owned 集合移除，避免悬挂 owned 状态。

## 错误模型（强错误 + 可读）

### 总原则

- **不掩盖错误**：遇到不可恢复状态直接 `luaL_error(...)`（Lua 侧得到明确错误并中断当前调用）。
- **错误必须可读**：错误信息包含：
  - 模块/函数名
  - 关键参数（如 `handle`、方法名、尺寸等）
  - 能获取到的对象类名/当前模式等上下文

### 错误分类

- **参数错误/状态错误（本插件可判定）**：直接 `luaL_error("func: invalid ...")`。
- **Godot 调用失败/不支持**：直接 `luaL_error("func: GodotError ...")`。

> 说明：Godot 内部很多失败路径是 `ERR_FAIL_*` 打日志并返回默认值，无法“自动捕获为异常”。因此需要在每个 API 封装层显式检查前置条件、返回码或可观察状态并转成 Lua error。

## 线程模型

- 所有 Lua → Godot 的 API 调用必须在 **主线程** 同步执行。
- 若未来需要后台线程，只能通过任务队列把工作切回主线程执行；不得在后台线程直接触碰 Godot 对象。
